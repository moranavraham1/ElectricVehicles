name: CD Workflow

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the latest code from the repository.
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Connect to your remote server via SSH and run deployment commands.
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            # Update package lists and install curl (if not already installed)
            echo "ğŸ”§ Updating system and installing curl..."
            sudo apt-get update -y && sudo apt-get install -y curl

            # Install 'n' to manage Node.js versions globally
            echo "ğŸ“¦ Installing n (Node version manager)..."
            sudo npm install -g n

            # Install the latest stable Node.js version
            echo "â¬†ï¸ Installing latest stable Node.js..."
            sudo n stable

            # Verify the installed Node.js version
            echo "âœ… Verifying Node.js version..."
            node -v
            npm -v

            # Install PM2 globally to manage Node processes
            echo "ğŸ”¨ Installing PM2 globally..."
            sudo npm install -g pm2

            # Install 'serve' globally for serving frontend builds
            echo "ğŸ”¨ Installing serve globally..."
            sudo npm install -g serve

            # Verify PM2 installation
            echo "âœ… Verifying PM2 version..."
            pm2 -v

            # Navigate to your project directory â€“ update the path accordingly.
            echo "ğŸš€ Navigating to project directory..."
            cd ~/ElectricVehicles

            # Checkout the main branch and pull the latest changes
            echo "ğŸ“‚ Checking out main branch and pulling latest changes..."
            git checkout main
            git pull

            # Install backend dependencies and start backend with PM2.
            echo "ğŸ“¦ Installing backend dependencies..."
            cd backend
            npm install

            # Remove any existing backend process to avoid 'Script already launched' error.
            echo "ğŸ§¹ Deleting any existing backend PM2 process..."
            pm2 delete backend || true

            echo "ğŸŸ¢ Starting backend with PM2..."
            pm2 start server.js --name "backend" --env production

            # Install frontend dependencies, build and start frontend with PM2.
            echo "ğŸ“¦ Installing frontend dependencies..."
            cd ../frontend
            npm install
            npm run build

            # Remove any existing frontend process before starting a new one.
            echo "ğŸ§¹ Deleting any existing frontend PM2 process..."
            pm2 delete frontend || true

            echo "ğŸŸ¢ Starting frontend with PM2..."
            pm2 start serve --name "frontend" -- -s build -l 3000
